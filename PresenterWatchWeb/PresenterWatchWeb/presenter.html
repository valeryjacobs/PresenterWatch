<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>PresenterWatch</title>
     <style type="text/css">
        .slice text {
            font-size: 16pt;
            font-family: Arial;
        }   
    </style>
</head>
<body>
    <div class="chart"></div>
    <script src="Scripts/moment.js" type="text/javascript"></script>
<script src="Scripts/d3.js" type="text/javascript"></script>
    <script type="text/javascript">

        var clockGroup, fields, height, offSetX, offSetY, pi, render, scaleHours, scaleSecs, vis, width;

        fields = function () {
            var currentTime, data, hour, minute, second;
            currentTime = new Date();
            second = currentTime.getSeconds();
            minute = currentTime.getMinutes();
            hour = currentTime.getHours() + minute / 60;
            return data = [
                     {
                         "seconds": second,
                         "minutes": minute,
                         "hours": hour
                     }
            ];
        };

        var startTime = new Date();
        var endTime = new Date();
        endTime.setMinutes(endTime.getMinutes() + 12);
        var totalSeconds = (endTime - startTime) / 1000;
        var intervalListener;
        var remainingSeconds;

        var w = 800,                        //width
        h = 800,                            //height
        r = 150,                            //radius
        color = d3.scale.category20c();     //builtin range of colors
        width = 800;
        height = 800;
        offSetX = 200;
        offSetY = 200;
        pi = Math.PI;

        piedata = [{ "label": "", "value": 10 }, { "label": "", "value": 90 }];
        scaleSecs = d3.scale.linear().domain([0, 59]).range([0, 2 * pi]);
        scaleHours = d3.scale.linear().domain([0, 11 + 59 / 60]).range([0, 2 * pi]);

        vis = d3.selectAll(".chart").append("svg:svg"); //.attr("width", width).attr("height", height);

        clockGroup = vis.append("svg:g").attr("transform", "translate(" + offSetX + "," + offSetY + ")");
        clockGroup.append("svg:circle").attr("r", 180).attr("fill", "none").attr("class", "clock outercircle").attr("stroke", "black").attr("stroke-width", 2);
        clockGroup.append("svg:circle").attr("r", 4).attr("fill", "black").attr("class", "clock innercircle");


        render = function (data) {
            var currentTime = new Date();

            remainingSeconds = Math.round((endTime - currentTime) / 700);

            if (remainingSeconds < 0) return;

            // console.log(remainingSeconds + "| " + totalSeconds);
            piedata = [{ "label": "", "value": totalSeconds - remainingSeconds },
                           { "label": "", "value": remainingSeconds }];
            console.log(remainingSeconds);
            console.log(totalSeconds - remainingSeconds);
            var vis = clockGroup
            //create the SVG element inside the <body>
                       .data([piedata])                   //associate our data with the document
                           .attr("width", w)           //set the width and height of our visualization (these will be attributes of the <svg> tag
                           .attr("height", h)
                       .append("svg:g")                //make a group to hold our pie chart
                           .attr("transform", "translate(" + 0 + "," + 0 + ")")    //move the center of the pie chart from 0, 0 to radius, radius

            var arc = d3.svg.arc()              //this will create <path> elements for us using arc data
                       .outerRadius(r);

            var pie = d3.layout.pie()           //this will create arc data for us given a list of values
                       .value(function (d) { return d.value; });    //we must tell it out to access the value of each element in our data array

            var arcs = vis.selectAll("g.slice")     //this selects all <g> elements with class slice (there aren't any yet)
                       .data(pie)                          //associate the generated pie data (an array of arcs, each having startAngle, endAngle and value properties) 
                       .enter()                            //this will create <g> elements for every "extra" data element that should be associated with a selection. The result is creating a <g> for every object in the data array
                           .append("svg:g")                //create a group to hold each slice (we will have a <path> and a <text> element associated with each slice)
                               .attr("class", "slice");    //allow us to style things in the slices (like text)

            arcs.append("svg:path")
                               .attr("fill", function (d, i) {
                                   console.log(totalSeconds / 2 < remainingSeconds);
                                   if (totalSeconds / 2 < remainingSeconds) {
                                       if (i == 0) { return "red"; }
                                       if (i == 1) { return "green"; }
                                   }
                                   else {
                                       if (i == 0) { return "green"; }
                                       if (i == 1) { return "red"; }
                                   }
                               }
                                     ) //set the color for each slice to be chosen from the color function defined above
                              .attr("d", arc)                                    //this creates the actual SVG path using the associated data (pie) with the arc drawing function
                               .append("svg:feGaussianBlur")
    .attr("stdDeviation", 5);

            arcs.append("svg:text")                                     //add a label to each slice
                               .attr("transform", function (d) {                    //set the label's origin to the center of the arc
                                   //we have to make sure to set these before calling arc.centroid
                                   d.innerRadius = 0;
                                   d.outerRadius = r;
                                   return "translate(" + arc.centroid(d) + ")";        //this gives us a pair of coordinates like [50, 50]
                               })
                           .attr("text-anchor", "middle")                          //center the text on it's origin
                           .text(function (d, i) { return piedata[i].label; });        //get the label from our original data array


            var secondArc = d3.svg.arc().innerRadius(0).outerRadius(170)
                   .startAngle(function (d) { return scaleSecs(d.seconds); })
                   .endAngle(function (d) { return scaleSecs(d.seconds); });

            var minuteArc = d3.svg.arc().innerRadius(0).outerRadius(170)
                   .startAngle(function (d) { return scaleSecs(d.minutes); })
                   .endAngle(function (d) { return scaleSecs(d.minutes); });

            var hourArc = d3.svg.arc().innerRadius(0).outerRadius(170)
                   .startAngle(function (d) { return scaleHours(d.hours % 12); })
                   .endAngle(function (d) { return scaleHours(d.hours % 12); });

            clockGroup.selectAll(".clockhand").remove();
            clockGroup.selectAll(".innercircle").remove();
            var clockHands = clockGroup.selectAll(".clockhand").data(data);
            clockHands.enter().append("g")
            // Attributes commont to all hands
                   .attr("class", "clockhand")
                   .attr("stroke", "black");

            // Add second hand
            clockHands.append("svg:path")
                   .attr("d", secondArc)
                   .attr("stroke-width", 2)
                   .attr("stroke", "yellow")
                    .append("svg:feGaussianBlur")
    .attr("stdDeviation", 5);


            // Add minute hand
            clockHands.append("svg:path")
                   .attr("d", minuteArc)
                   .attr("stroke-width", 4);

            // Add hour hand
            clockHands.append("svg:path")
                   .attr("d", hourArc)
                   .attr("stroke-width", 8);


            clockGroup.append("svg:circle").attr("r", 10).attr("fill", "black").attr("class", "clock innercircle");

        };
        // Show clock right away
        //render(fields());

        





    </script>
    <script src="http://code.jquery.com/jquery-1.8.2.min.js" type="text/javascript"></script>
<script src="Scripts/jquery.signalR-1.1.0.min.js" type="text/javascript"></script>
<script src="Scripts/moment.js" type="text/javascript"></script>
<script src="Scripts/d3.js" type="text/javascript"></script>
<!--  If this is an MVC project then use the following -->
<!--  <script src="~/signalr/hubs" type="text/javascript"></script> -->
<script src="signalr/hubs" type="text/javascript"></script>
<script type="text/javascript">
    $(function () {
        // Proxy created on the fly          
        var chat = $.connection.speakerWatchHub;

        // Declare a function on the chat hub so the server can invoke it          
        chat.client.addMessage = function (message) {
            $('#messages').append('<li>' + message + '</li>');
        };

        chat.client.start = function (duration) {
            console.log(duration);

            startTime = new Date();
            endTime = new Date();
            endTime.setMinutes(endTime.getMinutes() + duration);
            totalSeconds = (endTime - startTime) / 1000;

            intervalListener = self.setInterval(function () {
                var data;
                data = fields();
                return render(data);
            }, 1000);
        };

        chat.client.stop = function () {
            window.clearInterval(intervalListener);
        };

        chat.client.add5 = function () {
            totalSeconds += 300;
            remainingSeconds += 300;
        };

        chat.client.add10 = function () {
            totalSeconds += 600;
            remainingSeconds += 600;
        };

        chat.client.getAttention = function () {
            alert("Hey!");
        };

        chat.client.sendComment = function (comment) {
            alert(comment);
        };

        // Start the connection
        $.connection.hub.start().done(function () {
            //$("#broadcast").click(function () {
            //    // Call the chat method on the server
            //    chat.server.send($('#msg').val());
            //});
        });
    });
</script>
  
  <div>
   


<ul id="messages">
</ul>
  </div>

</body>
</html>
